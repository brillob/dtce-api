@model Dtce.WebClient.Models.JobViewModel
@{
    ViewData["Title"] = "DTCE API - Document Template & Context Extractor";
    Layout = "_Layout";
}

<div class="container" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
    <!-- Section 1: Document Submission -->
    <div class="card" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 30px;">
        <h2 style="color: #333; font-weight: bold; margin-bottom: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            1. Document Submission (POST /jobs/submit)
        </h2>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; color: #666; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <input type="radio" name="inputType" value="file" checked style="margin-right: 8px; accent-color: #007bff;">
                File Upload (.docx, .pdf)
            </label>
            <label style="display: block; margin-bottom: 10px; color: #666; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <input type="radio" name="inputType" value="url" style="margin-right: 8px; accent-color: #007bff;">
                Google Doc URL
            </label>
        </div>

        <div id="fileUploadSection" style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; color: #666; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Select Document (Max 50MB)
            </label>
            <div style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background: #f9f9f9;">
                <input type="file" id="documentFile" name="document" accept=".docx,.pdf" style="display: none;">
                <button type="button" onclick="document.getElementById('documentFile').click()" 
                        style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin-right: 10px;">
                    Choose file
                </button>
                <span id="fileName" style="color: #999; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">No file chosen</span>
            </div>
        </div>

        <div id="urlInputSection" style="margin-bottom: 20px; display: none;">
            <label style="display: block; margin-bottom: 8px; color: #666; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Google Doc URL
            </label>
            <input type="text" id="documentUrl" name="documentUrl" 
                   placeholder="https://docs.google.com/document/d/..." 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; color: #666; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Select API Key <a href="/ApiKey" style="color: #007bff; text-decoration: none; font-size: 12px;">(Manage Keys)</a>
            </label>
            <select id="apiKeySelect" name="apiKey" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                <option value="">-- Select API Key --</option>
                @foreach (var apiKey in Model.ApiKeys)
                {
                    <option value="@apiKey.Key">@apiKey.Name</option>
                }
            </select>
            @if (!Model.ApiKeys.Any())
            {
                <div style="margin-top: 8px; color: #dc3545; font-size: 14px;">
                    No API keys found. <a href="/ApiKey" style="color: #007bff;">Create one here</a>
                </div>
            }
        </div>

        <button type="button" id="submitBtn" 
                style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 500; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; box-shadow: 0 2px 4px rgba(0,123,255,0.3); width: 100%;">
            Submit Document
        </button>
    </div>

    <!-- Section 2: Job Status and Results -->
    <div class="card" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px;">
        <h2 style="color: #333; font-weight: bold; margin-bottom: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            2. Job Status and Results
        </h2>
        <hr style="border: none; border-top: 1px solid #eee; margin-bottom: 20px;">
        
        <div style="margin-bottom: 15px;">
            <div style="color: #666; font-size: 14px; margin-bottom: 5px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Job ID (202 Accepted)
            </div>
            <div id="jobId" style="color: #333; font-weight: bold; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                N/A
            </div>
        </div>

        <div>
            <div style="color: #666; font-size: 14px; margin-bottom: 5px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Current Status (GET /status)
            </div>
            <div id="jobStatus" style="color: #333; font-weight: bold; font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; align-items: center;">
                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #999; margin-right: 8px;"></span>
                <span id="statusText">Idle</span>
            </div>
            <div id="statusMessage" style="color: #666; font-size: 14px; margin-top: 5px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"></div>
        </div>

        <div id="resultsSection" style="margin-top: 20px; display: none;">
            <div style="color: #666; font-size: 14px; margin-bottom: 10px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                Results:
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="color: #666; font-size: 14px; min-width: 120px;">Template JSON:</span>
                    <a id="templateJsonLink" href="#" target="_blank" 
                       style="background: #007bff; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block; margin-right: 8px;">
                        📄 View
                    </a>
                    <a id="templateJsonDownloadLink" href="#" 
                       style="background: #6c757d; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block;">
                        ⬇ Download
                    </a>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="color: #666; font-size: 14px; min-width: 120px;">Context JSON:</span>
                    <a id="contextJsonLink" href="#" target="_blank" 
                       style="background: #28a745; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block; margin-right: 8px;">
                        📄 View
                    </a>
                    <a id="contextJsonDownloadLink" href="#" 
                       style="background: #6c757d; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block;">
                        ⬇ Download
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentJobId = null;
    let statusPollInterval = null;

    // Handle input type change
    document.querySelectorAll('input[name="inputType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'file') {
                document.getElementById('fileUploadSection').style.display = 'block';
                document.getElementById('urlInputSection').style.display = 'none';
            } else {
                document.getElementById('fileUploadSection').style.display = 'none';
                document.getElementById('urlInputSection').style.display = 'block';
            }
        });
    });

    // Handle file selection
    document.getElementById('documentFile').addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name || 'No file chosen';
        document.getElementById('fileName').textContent = fileName;
    });

    // Handle form submission
    document.getElementById('submitBtn').addEventListener('click', async function() {
        const inputType = document.querySelector('input[name="inputType"]:checked').value;
        const formData = new FormData();
        
        if (inputType === 'file') {
            const fileInput = document.getElementById('documentFile');
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            formData.append('document', fileInput.files[0]);
        } else {
            const urlInput = document.getElementById('documentUrl').value;
            if (!urlInput) {
                alert('Please enter a Google Doc URL');
                return;
            }
            formData.append('documentUrl', urlInput);
        }
        formData.append('inputType', inputType);
        
        const apiKey = document.getElementById('apiKeySelect').value;
        if (!apiKey) {
            alert('Please select an API key');
            return;
        }
        formData.append('apiKey', apiKey);

        try {
            const response = await fetch('/Home/SubmitJob', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (result.success) {
                currentJobId = result.jobId;
                document.getElementById('jobId').textContent = currentJobId;
                document.getElementById('statusText').textContent = 'Pending';
                updateStatusIndicator('pending');
                startStatusPolling();
            } else {
                alert(result.message || 'Failed to submit job');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while submitting the job');
        }
    });

    function startStatusPolling() {
        if (statusPollInterval) {
            clearInterval(statusPollInterval);
        }

        statusPollInterval = setInterval(async () => {
            if (!currentJobId) return;

            try {
                const apiKey = document.getElementById('apiKeySelect').value;
                const response = await fetch(`/Home/GetJobStatus?jobId=${currentJobId}&apiKey=${encodeURIComponent(apiKey)}`);
                const result = await response.json();

                if (result.status) {
                    document.getElementById('statusText').textContent = result.status;
                    document.getElementById('statusMessage').textContent = result.statusMessage || '';
                    
                    updateStatusIndicator(result.status.toLowerCase());

                    if (result.status === 'Complete') {
                        clearInterval(statusPollInterval);
                        if (result.templateJsonUrl && result.contextJsonUrl) {
                            document.getElementById('resultsSection').style.display = 'block';
                            document.getElementById('templateJsonLink').href = result.templateJsonUrl;
                            document.getElementById('templateJsonDownloadLink').href = result.templateJsonUrl + (result.templateJsonUrl.includes('?') ? '&' : '?') + 'download=true';
                            document.getElementById('contextJsonLink').href = result.contextJsonUrl;
                            document.getElementById('contextJsonDownloadLink').href = result.contextJsonUrl + (result.contextJsonUrl.includes('?') ? '&' : '?') + 'download=true';
                        }
                    } else if (result.status === 'Failed') {
                        clearInterval(statusPollInterval);
                        document.getElementById('resultsSection').style.display = 'none';
                    }
                } else {
                    document.getElementById('resultsSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error polling status:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    function updateStatusIndicator(status) {
        const indicator = document.querySelector('#jobStatus span');
        if (status === 'complete') {
            indicator.style.background = '#28a745';
        } else if (status === 'failed') {
            indicator.style.background = '#dc3545';
        } else if (status === 'pending' || status === 'processing' || status.includes('progress')) {
            indicator.style.background = '#ffc107';
        } else {
            indicator.style.background = '#999';
        }
    }
</script>

<style>
    body {
        background: #f5f5f5;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        padding: 0;
    }
</style>
